version: 2.1

jobs:


    
  Build-Backend:
    docker:
      - image: cimg/node:13.8.0
    steps:
      - checkout

      - run: |
          cd backend
          npm i
          npm run build

      - save_cache:
          paths: 
            - backend/node_modules
            - backend/dist            
          key: backend-build -{{ checksum "package-lock.json" }}



  Build-Frontend:
    docker:
      - image: cimg/node:13.8.0
    steps:
      - checkout

      - run: |
          cd frontend
          npm install
          npm run build

      - save_cache:
          paths: 
            - frontend/node_modules
            - frontend/dist
          key: frontend-build -{{ checksum "package-lock.json" }}


  Test-Frontend:
    docker:
      - image: cimg/node:13.8.0
    steps:
      - checkout
      - restore_cache:
          key: frontend-build -{{ checksum "package-lock.json" }}
      - run: |
          cd frontend
          npm test
  Test-Backend:
    docker:
      - image: cimg/node:13.8.0
    steps:
      - checkout
      - restore_cache:
          key: backend-build -{{ checksum "package-lock.json" }}
      - run: |
          cd backend
          npm test




  Scan-Frontend:
    docker:
      - image: cimg/node:13.8.0
    steps:
      - checkout
      - restore_cache:
          key : frontend-build -{{ checksum "package-lock.json" }}
      - run : |
          cd frontend
          npm audit --audit-level=critical
      - run:
          name: Fix Audit problems 
          command: |
            cd frontend
            npm audit fix --audit-level=critical --force
          when: on_fail

  Scan-Backend:
    docker:
      - image: cimg/node:13.8.0
    steps:
      - checkout
      - restore_cache:
          key : backend-build -{{ checksum "package-lock.json" }}
      - run : |
          cd backend
          npm audit --audit-level=critical
      - run:
          name: Fix Audi problems 
          command: |
            cd backend
            npm audit fix --audit-level=critical --force
          when: on_fail
workflows:
  Default:
    jobs:
      - Build-Frontend
      - Build-Backend
      - Test-Frontend :
          requires : 
            - Build-Frontend
      - Test-Backend: 
          requires : 
            - Build-Backend
      - Scan-Frontend : 
          requires:
            - Test-Frontend
      - Scan-Backend: 
          requires:
            - Test-Backend

